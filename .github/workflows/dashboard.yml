name: Dashboard Data Collector

on:
  schedule:
    # 15:00 giờ Việt Nam (UTC+7) = 08:00 UTC, thứ 2-6
    - cron: '0 8 * * 1-5'
  workflow_dispatch:
    inputs:
      date:
        description: 'Ngày thu thập (YYYY-MM-DD), bỏ trống = hôm nay'
        required: false
        default: ''
      indices_start:
        description: 'Ngày bắt đầu chỉ số (YYYY-MM-DD). Mặc định: 1 năm trước'
        required: false
        default: ''
      indices_end:
        description: 'Ngày kết thúc chỉ số (YYYY-MM-DD). Mặc định: hôm nay'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytz matplotlib

      - name: Set timezone to Vietnam
        run: echo "TZ=Asia/Ho_Chi_Minh" >> $GITHUB_ENV

      - name: Register API key
        if: ${{ env.VNSTOCK_API_KEY != '' }}
        run: |
          python -c "
          from vnstock.core.utils.auth import register_user
          import os
          key = os.environ.get('VNSTOCK_API_KEY', '')
          if key:
              register_user(api_key=key)
              print('API key registered (Golden Sponsor: 500 req/min)')
          "
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}

      - name: Determine collection date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "date=$(TZ=Asia/Ho_Chi_Minh date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi

      - name: Check if weekday (skip weekends for scheduled runs)
        id: check_day
        run: |
          DAY_OF_WEEK=$(TZ=Asia/Ho_Chi_Minh date +%u)
          if [ "$DAY_OF_WEEK" -gt 5 ] && [ "${{ github.event_name }}" = "schedule" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Hôm nay là cuối tuần, bỏ qua."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      # ========== PHẦN 1: THU THẬP DỮ LIỆU CỔ PHIẾU ==========
      - name: "[1/3] Thu thập dữ liệu cổ phiếu"
        if: steps.check_day.outputs.skip != 'true'
        run: |
          python scripts/daily_collector.py --date ${{ steps.date.outputs.date }} --skip-ohlcv
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}

      # ========== PHẦN 2: THU THẬP OHLCV TOP 500 CỔ PHIẾU ==========
      - name: "[2/3] Thu thập OHLCV top 500 cổ phiếu vốn hóa"
        if: steps.check_day.outputs.skip != 'true'
        run: |
          python scripts/collect_stocks.py
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}

      # ========== PHẦN 3: THU THẬP DỮ LIỆU CHỈ SỐ ==========
      - name: "[3/3] Thu thập 18 chỉ số thị trường + charts"
        if: steps.check_day.outputs.skip != 'true'
        run: |
          START_FLAG=""
          END_FLAG=""
          if [ -n "${{ github.event.inputs.indices_start }}" ]; then
            START_FLAG="--start ${{ github.event.inputs.indices_start }}"
          fi
          if [ -n "${{ github.event.inputs.indices_end }}" ]; then
            END_FLAG="--end ${{ github.event.inputs.indices_end }}"
          fi
          python scripts/collect_indices.py $START_FLAG $END_FLAG
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}

      # ========== HIỂN THỊ KẾT QUẢ ==========
      - name: Show collected files
        if: steps.check_day.outputs.skip != 'true'
        run: |
          echo "=========================================="
          echo "  DỮ LIỆU CỔ PHIẾU (${{ steps.date.outputs.date }})"
          echo "=========================================="
          if [ -d "data/${{ steps.date.outputs.date }}" ]; then
            ls -lh data/${{ steps.date.outputs.date }}/
          else
            echo "Không có thư mục data."
          fi
          echo ""
          echo "=========================================="
          echo "  OHLCV TOP 500 CỔ PHIẾU"
          echo "=========================================="
          ls data/stocks/*.csv 2>/dev/null | wc -l | xargs -I{} echo "{} files"
          ls -lh data/stocks/*.csv 2>/dev/null | head -10
          echo ""
          echo "=========================================="
          echo "  DỮ LIỆU CHỈ SỐ (18 indices)"
          echo "=========================================="
          ls -lh data/indices/*.csv 2>/dev/null || echo "No CSV files"
          echo ""
          echo "=== Charts ==="
          ls -lh data/indices/charts/*.png 2>/dev/null || echo "No chart files"

      # ========== COMMIT & PUSH ==========
      - name: Commit and push all data
        if: steps.check_day.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          if git diff --staged --quiet; then
            echo "Không có dữ liệu mới."
          else
            DATE=${{ steps.date.outputs.date }}
            git commit -m "data: dashboard $DATE (cổ phiếu + OHLCV 500 mã + 18 chỉ số)"
            git push
          fi

      - name: Upload artifacts
        if: steps.check_day.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-data-${{ steps.date.outputs.date }}
          path: |
            data/${{ steps.date.outputs.date }}/
            data/stocks/
            data/indices/
          retention-days: 90
