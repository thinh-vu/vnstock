name: Financial Data Collector

on:
  schedule:
    # Chạy hàng tuần: Thứ 2, 08:30 UTC = 15:30 VN
    - cron: '30 8 * * 1'
  workflow_dispatch:
    inputs:
      top_n:
        description: 'Số mã vốn hóa lớn nhất (mặc định: 500)'
        required: false
        default: '500'
      period:
        description: 'Kỳ báo cáo: year, quarter, hoặc bỏ trống = cả hai'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  financials:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Register API key
        if: ${{ env.VNSTOCK_API_KEY != '' }}
        run: |
          python -c "
          from vnstock.core.utils.auth import register_user
          import os
          key = os.environ.get('VNSTOCK_API_KEY', '')
          if key:
              register_user(api_key=key)
              print('API key registered')
          "
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}

      - name: Collect financial data
        run: |
          TOP_N="${{ github.event.inputs.top_n }}"
          PERIOD="${{ github.event.inputs.period }}"
          FLAGS="--top-n ${TOP_N:-500}"
          if [ -n "$PERIOD" ]; then
            FLAGS="$FLAGS --period $PERIOD"
          fi
          python scripts/collect_financials.py $FLAGS
        env:
          VNSTOCK_API_KEY: ${{ secrets.VNSTOCK_API_KEY }}

      - name: Show results
        run: |
          echo "=========================================="
          echo "  DỮ LIỆU TÀI CHÍNH"
          echo "=========================================="
          ls data/financials/ 2>/dev/null | wc -l | xargs -I{} echo "{} companies"
          ls data/financials/ 2>/dev/null | head -20
          echo "..."
          echo ""
          echo "=== Sample (first company) ==="
          FIRST=$(ls data/financials/ 2>/dev/null | head -1)
          if [ -n "$FIRST" ]; then
            ls -lh "data/financials/$FIRST/"
          fi

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/financials/
          if git diff --staged --quiet; then
            echo "Không có dữ liệu mới."
          else
            git commit -m "data: financial reports $(date +%Y-%m-%d)"
            git push
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: financial-data-${{ github.run_id }}
          path: data/financials/
          retention-days: 90
